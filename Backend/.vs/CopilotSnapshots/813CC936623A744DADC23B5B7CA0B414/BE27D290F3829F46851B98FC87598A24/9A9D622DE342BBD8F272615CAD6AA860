using Aplication.DTOs;
using Aplication.UseCases.Productos;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Hosting;
using System;

namespace API.Controllers
{
 [ApiController]
 [Route("api/productos")]
 public class ProductosController : ControllerBase
 {
 private readonly CrearProducto _crear;
 private readonly ActualizarProducto _actualizar;
 private readonly EliminarProducto _eliminar;
 private readonly ObtenerProductoPorId _obtener;
 private readonly ListarProductos _listar;
 public ProductosController(CrearProducto crear, ActualizarProducto actualizar, EliminarProducto eliminar, ObtenerProductoPorId obtener, ListarProductos listar)
 { _crear = crear; _actualizar = actualizar; _eliminar = eliminar; _obtener = obtener; _listar = listar; }

 [HttpGet]
 public async Task<IActionResult> Listar() => Ok(await _listar.EjecutarAsync());

 [HttpGet("{id:int}")]
 public async Task<IActionResult> Obtener(int id)
 {
 var prod = await _obtener.EjecutarAsync(id);
 if (prod == null) return NotFound();
 return Ok(prod);
 }

 [HttpPost]
 [Authorize(Roles="administrador")]
 public async Task<IActionResult> Crear([FromBody] ProductoDTO dto)
 {
 if(!ModelState.IsValid) return BadRequest(ModelState);
 var id = await _crear.EjecutarAsync(dto);
 return CreatedAtAction(nameof(Obtener), new { id }, new { id });
 }

 [HttpPut("{id:int}")]
 [Authorize(Roles="administrador")]
 public async Task<IActionResult> Actualizar(int id, [FromBody] ProductoDTO dto)
 {
 if(id!=dto.Id) return BadRequest("Id mismatch");
 await _actualizar.EjecutarAsync(dto);
 return Ok();
 }

 [HttpDelete("{id:int}")]
 [Authorize(Roles="administrador")]
 public async Task<IActionResult> Eliminar(int id)
 {
 await _eliminar.EjecutarAsync(id);
 return NoContent();
 }

 [HttpPost("{id:int}/imagen")]
 [Authorize(Roles="administrador")]
 public async Task<IActionResult> SubirImagen(int id, IFormFile archivo)
 {
 if(archivo==null || archivo.Length==0) return BadRequest("Archivo vacío");
 var producto = await _obtener.EjecutarAsync(id);
 if(producto==null) return NotFound();
 var ext = System.IO.Path.GetExtension(archivo.FileName).ToLowerInvariant();
 var permitidas = new[]{ ".jpg", ".jpeg", ".png", ".webp" };
 if(!permitidas.Contains(ext)) return BadRequest("Formato no permitido");
 var nombre = $"prod_{id}_{Guid.NewGuid():N}{ext}";
 var rutaCarpeta = System.IO.Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "imagenes_productos");
 if(!Directory.Exists(rutaCarpeta)) Directory.CreateDirectory(rutaCarpeta);
 var rutaFisica = System.IO.Path.Combine(rutaCarpeta, nombre);
 using(var stream = System.IO.File.Create(rutaFisica))
 { await archivo.CopyToAsync(stream); }
 // Actualizar producto con nueva URL
 producto.ImagenUrl = $"/imagenes_productos/{nombre}";
 await _actualizar.EjecutarAsync(producto);
 return Ok(new { imagen = producto.ImagenUrl });
 }

 [HttpPost("con-imagen")]
 [Authorize(Roles="administrador")]
 public async Task<IActionResult> CrearConImagen([FromForm] API.Models.ProductoCrearConImagenRequest form)
 {
 if(!ModelState.IsValid) return BadRequest(ModelState);
 try
 {
 var dto = new ProductoDTO
 {
 Nombre = form.Nombre,
 Descripcion = form.Descripcion,
 Precio = form.Precio,
 Categoria = form.Categoria,
 Activo = form.Activo,
 StockMinimo = form.StockMinimo
 };
 var id = await _crear.EjecutarAsync(dto);
 if(form.Imagen!=null && form.Imagen.Length>0)
 {
 var ext = System.IO.Path.GetExtension(form.Imagen.FileName).ToLowerInvariant();
 var permitidas = new[]{ ".jpg", ".jpeg", ".png", ".webp" };
 if(!permitidas.Contains(ext)) return BadRequest("Formato no permitido");
 var nombre = $"prod_{id}_{Guid.NewGuid():N}{ext}";
 var carpeta = System.IO.Path.Combine( (HttpContext.RequestServices.GetRequiredService<IWebHostEnvironment>()).WebRootPath, "imagenes_productos");
 if(!Directory.Exists(carpeta)) Directory.CreateDirectory(carpeta);
 var rutaFisica = System.IO.Path.Combine(carpeta, nombre);
 using(var stream = System.IO.File.Create(rutaFisica)) { await form.Imagen.CopyToAsync(stream); }
 var actualizado = new ProductoDTO{ Id=id, Nombre=form.Nombre, Descripcion=form.Descripcion, Precio=form.Precio, Categoria=form.Categoria, Activo=form.Activo, StockMinimo=form.StockMinimo, ImagenUrl=$"/imagenes_productos/{nombre}" };
 await _actualizar.EjecutarAsync(actualizado);
 }
 return CreatedAtAction(nameof(Obtener), new { id }, new { id });
 }
 catch(Exception ex)
 {
 return StatusCode(500, new { mensaje = ex.Message });
 }
 }
 }
}
