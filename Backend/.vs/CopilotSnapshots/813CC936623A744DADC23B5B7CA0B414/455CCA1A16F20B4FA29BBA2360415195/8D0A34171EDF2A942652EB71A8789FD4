using Aplication.Mapping;
using Aplication.UseCases.Pedidos;
using Aplication.UseCases.Productos;
using Aplication.UseCases.Inventarios;
using Aplication.UseCases.Usuarios;
using Aplication.UseCases.Reportes;
using Domain.Interfaces;
using Infraestructure.Data;
using Infraestructure.Repositorios;
using Microsoft.EntityFrameworkCore;
using System.Text.Json.Serialization;
using API.Hubs;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using API.Middleware;

var builder = WebApplication.CreateBuilder(args);

// Configuración JWT simple
var jwtKey = builder.Configuration["Jwt:Key"] ?? "ClaveSuperSecretaMinima123456789"; // usar secreto seguro
var keyBytes = Encoding.UTF8.GetBytes(jwtKey);

builder.Services.AddAuthentication(options =>
{
 options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
 options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
 options.TokenValidationParameters = new TokenValidationParameters
 {
 ValidateIssuer = false,
 ValidateAudience = false,
 ValidateIssuerSigningKey = true,
 IssuerSigningKey = new SymmetricSecurityKey(keyBytes),
 ValidateLifetime = true,
 ClockSkew = TimeSpan.FromMinutes(1)
 };
});

builder.Services.AddCors(options =>
{
 options.AddPolicy("AllowFrontend", policy =>
 {
 policy.WithOrigins(
 "http://localhost:5173",
 "http://localhost:5174",
 "http://localhost:3000"
 )
 .AllowAnyHeader()
 .AllowAnyMethod()
 .AllowCredentials();
 });
});

builder.Services.AddDbContext<AppDbContext>(options =>
 options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

builder.Services.AddAutoMapper(typeof(MappingProfile));

// SignalR
builder.Services.AddSignalR();

// Repositorios
builder.Services.AddScoped<IProductoRepositorio, ProductoRepositorio>();
builder.Services.AddScoped<IInventarioRepositorio, InventarioRepositorio>();
builder.Services.AddScoped<IPedidoRepositorio, PedidoRepositorio>();
builder.Services.AddScoped<IPagoRepositorio, PagoRepositorio>();
builder.Services.AddScoped<IUsuarioRepositorio, UsuarioRepositorio>();

// Casos de uso pedidos
builder.Services.AddScoped<CrearPedido>();
builder.Services.AddScoped<ListarPedidos>();
builder.Services.AddScoped<ActualizarEstadoPedido>();
builder.Services.AddScoped<RegistrarPagoPedido>();

// Casos de uso productos
builder.Services.AddScoped<CrearProducto>();
builder.Services.AddScoped<ActualizarProducto>();
builder.Services.AddScoped<EliminarProducto>();
builder.Services.AddScoped<ObtenerProductoPorId>();
builder.Services.AddScoped<ListarProductos>();

// Casos de uso inventario
builder.Services.AddScoped<CrearInventario>();
builder.Services.AddScoped<ActualizarInventario>();
builder.Services.AddScoped<ObtenerInventarioPorProducto>();
builder.Services.AddScoped<ListarInventarios>();
builder.Services.AddScoped<GenerarAlertasStockMinimo>();

// Casos de uso usuarios
builder.Services.AddScoped<RegistrarUsuario>();
builder.Services.AddScoped<Login>();
builder.Services.AddScoped<ListarUsuarios>();

// Casos de uso reportes
builder.Services.AddScoped<GenerarReporteInventario>();

builder.Services.AddControllers().AddJsonOptions(options =>
{
 options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
 options.JsonSerializerOptions.DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull;
});

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddAuthorization();

var app = builder.Build();

// Aplicar migraciones automáticas
using (var scope = app.Services.CreateScope())
{
 var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
 db.Database.Migrate();
}

if (app.Environment.IsDevelopment())
{
 app.UseSwagger();
 app.UseSwaggerUI();
}

app.UseCors("AllowFrontend");
app.UseHttpsRedirection();
app.UseAuthentication();
app.UseMiddleware<AuditMiddleware>();
app.UseAuthorization();
app.UseStaticFiles();
app.MapControllers();
app.MapHub<PedidosHub>("/hubs/pedidos");
app.Run();
