using Aplication.DTOs;
using Aplication.UseCases.Pedidos;
using Domain.Entities;
using Microsoft.AspNetCore.Mvc;
using System;
using System.Threading.Tasks;

namespace API.Controllers
{
 [ApiController]
 [Route("api/pedidos")]
 public class PedidosController : ControllerBase
 {
 private readonly CrearPedido _crear;
 private readonly ListarPedidos _listar;
 private readonly ActualizarEstadoPedido _actualizarEstado;
 private readonly RegistrarPagoPedido _registrarPago;
 private readonly IPedidoRepositorio _pedidoRepo;
 public PedidosController(CrearPedido crear, ListarPedidos listar, ActualizarEstadoPedido actualizarEstado, RegistrarPagoPedido registrarPago, IPedidoRepositorio pedidoRepo)
 { _crear = crear; _listar = listar; _actualizarEstado = actualizarEstado; _registrarPago = registrarPago; _pedidoRepo = pedidoRepo; }

 [HttpPost]
 public async Task<IActionResult> Crear([FromBody] PedidoDTO dto)
 {
 try
 {
 var id = await _crear.EjecutarAsync(dto);
 return Ok(new { pedidoId = id });
 }
 catch(Exception ex){ return BadRequest(new { mensaje = ex.Message }); }
 }

 [HttpGet]
 public async Task<IActionResult> Listar()
 => Ok(await _listar.EjecutarAsync());

 [HttpGet("{id:guid}")]
 public async Task<IActionResult> Obtener(Guid id)
 {
 var pedido = await _pedidoRepo.ObtenerPorIdAsync(id);
 if(pedido==null) return NotFound();
 return Ok(pedido);
 }

 [HttpPut("{id:guid}/estado")]
 public async Task<IActionResult> ActualizarEstado(Guid id, [FromQuery] EstadoPedido estado)
 {
 try
 {
 await _actualizarEstado.EjecutarAsync(id, estado);
 return Ok(new { mensaje = "Estado actualizado" });
 }
 catch(Exception ex){ return BadRequest(new { mensaje = ex.Message }); }
 }

 [HttpDelete("{id:guid}")]
 public async Task<IActionResult> Eliminar(Guid id)
 {
 var pedido = await _pedidoRepo.ObtenerPorIdAsync(id);
 if(pedido==null) return NotFound();
 // Eliminación lógica: marcar CANCELADO si no lo está
 if(pedido.Estado != EstadoPedido.CANCELADO)
 {
 pedido.Estado = EstadoPedido.CANCELADO;
 pedido.HistorialEstados.Add(new PedidoEstadoHistorial{ Id=Guid.NewGuid(), PedidoId=pedido.Id, Estado=pedido.Estado, CambioEn=DateTime.UtcNow});
 await _pedidoRepo.ActualizarAsync(pedido);
 }
 return NoContent();
 }

 [HttpPost("{id:guid}/pago")]
 public async Task<IActionResult> RegistrarPago(Guid id, [FromBody] PagoDTO dto)
 {
 if (id != dto.PedidoId) return BadRequest(new { mensaje = "Id mismatch" });
 try
 {
 var pagoId = await _registrarPago.EjecutarAsync(dto);
 return Ok(new { pagoId });
 }
 catch(Exception ex){ return BadRequest(new { mensaje = ex.Message }); }
 }
 }
}
