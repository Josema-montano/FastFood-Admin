using Aplication.DTOs;
using Aplication.UseCases.Pedidos;
using Domain.Entities;
using Microsoft.AspNetCore.Mvc;
using System;
using System.Threading.Tasks;

namespace API.Controllers
{
 [ApiController]
 [Route("api/pedidos")]
 public class PedidosController : ControllerBase
 {
 private readonly CrearPedido _crear;
 private readonly ListarPedidos _listar;
 private readonly ActualizarEstadoPedido _actualizarEstado;
 private readonly RegistrarPagoPedido _registrarPago;
 public PedidosController(CrearPedido crear, ListarPedidos listar, ActualizarEstadoPedido actualizarEstado, RegistrarPagoPedido registrarPago)
 { _crear = crear; _listar = listar; _actualizarEstado = actualizarEstado; _registrarPago = registrarPago; }

 [HttpPost]
 public async Task<IActionResult> Crear([FromBody] PedidoDTO dto)
 {
 try
 {
 var id = await _crear.EjecutarAsync(dto);
 return Ok(new { pedidoId = id });
 }
 catch(Exception ex){ return BadRequest(new { mensaje = ex.Message }); }
 }

 [HttpGet]
 public async Task<IActionResult> Listar()
 => Ok(await _listar.EjecutarAsync());

 [HttpPut("{id}/estado")]
 public async Task<IActionResult> ActualizarEstado(Guid id, [FromQuery] EstadoPedido estado)
 {
 try
 {
 await _actualizarEstado.EjecutarAsync(id, estado);
 return Ok(new { mensaje = "Estado actualizado" });
 }
 catch(Exception ex){ return BadRequest(new { mensaje = ex.Message }); }
 }

 [HttpPost("{id}/pago")]
 public async Task<IActionResult> RegistrarPago(Guid id, [FromBody] PagoDTO dto)
 {
 if (id != dto.PedidoId) return BadRequest(new { mensaje = "Id mismatch" });
 try
 {
 var pagoId = await _registrarPago.EjecutarAsync(dto);
 return Ok(new { pagoId });
 }
 catch(Exception ex){ return BadRequest(new { mensaje = ex.Message }); }
 }
 }
}
